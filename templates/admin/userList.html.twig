{# admin/companyList.html.twig #}
{% extends 'admin-base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="/assets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/assets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="/assets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
{% endblock %}

{% block breadcrum %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active">Users</li>
    </ol>
{% endblock %}

{% block body %}
    <div class="modal fade" id="modal-user-form">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="form-title">Add / Edit Company</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <div class="modal-body">
                    <form id="user-form" name="userForm" method="post" action="/api/user/add">
                        <input type="hidden" name="id" id="form-id" value=""/>
                        <table border="0">
                            <tr>
                                <th align="right">Nickname</th>
                                <td><input type="text" name="nickname" id="form-nickname"/></td>
                            </tr>
                            <tr>
                                <th align="right">Email</th>
                                <td><input type="text" name="email" id="form-email"/></td>
                            </tr>
                            <tr>
                                <th align="right">First Name</th>
                                <td><input type="text" name="firstName" id="form-first-name"/></td>
                            </tr>
                            <tr>
                                <th align="right">Last Name</th>
                                <td><input type="text" name="lastName" id="form-last-name"/></td>
                            </tr>
                            <tr>
                                <th align="right">Password</th>
                                <td><input type="text" name="passwordHash" id="form-password-hash"/></td>
                            </tr>
                            <tr>
                                <th align="right">Streaming Key</th>
                                <td><input type="text" name="streamingKey" id="form-streaming-key"/></td>
                            </tr>
                            <tr>
                                <th align="right">Profile Pic</th>
                                <td><input type="text" name="profileImage" id="form-profile-image"/></td>
                            </tr>
                            <tr>
                                <th align="right">Bio</th>
                                <td><input type="text" name="bio" id="form-bio"/></td>
                            </tr>
                            <tr>
                                <td align="right"><button name="btnCancel" id="btnCancel" onclick="cancel()">Cancel</button></td>
                                <td><button name="btnSave" id="btnSave" onclick="save()">Save</button></td>
                            </tr>
                        </table>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </div>

    <!-- view user modal window -->
    <div class="modal fade" id="modal-user-view">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="view-title">Add / Edit User - (No user selected)</h4>
                    <button type="button" class="add-stream" data-toggle="modal" data-target="#modal-add-stream" aria-label="Add Stream" id="btnAddStream">
                        <span class="glyphicon glyphicon-align-left" aria-hidden="true">Grant Streaming Permissions</span>
                    </button>
                    <button type="button" class="remove-stream" data-toggle="modal" data-target="#modal-remove-stream" aria-label="Remove Stream" id="btnRemoveStream">
                        <span class="glyphicon glyphicon-align-left" aria-hidden="true">Revoke Streaming Permissions</span>
                    </button>
                    <button type="button" class="edit" data-toggle="modal" data-target="#modal-user-form, #modal-user-view" aria-label="Edit" id="btnEditUser">
                        <span class="glyphicon glyphicon-align-left" aria-hidden="true">Edit</span>
                    </button>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-body">

                        <table border="0">
                            <tr>
                                <th align="right">Record ID</th>
                                <td id="view-id"></td>
                            </tr>
                            <tr>
                                <th align="right">Nickname</th>
                                <td id="view-nickname"></td>
                            </tr>
                            <tr>
                                <th align="right">First Name</th>
                                <td id="view-first-name"></td>
                            </tr>
                            <tr>
                                <th align="right">Last Name</th>
                                <td id="view-last-name"></td>
                            </tr>
                            <tr>
                                <th align="right">Email</th>
                                <td id="view-email"></td>
                            </tr>
                            <tr>
                                <th align="right">Password</th>
                                <td id="view-password-hash"></td>
                            </tr>
                            <tr>
                                <th align="right">Streaming Key</th>
                                <td id="view-streaming-key"></td>
                            </tr>
                            <tr>
                                <th align="right">Profile Image</th>
                                <td id="view-profile-image"></td>
                            </tr>
                            <tr>
                                <th align="right">Category</th>
                                <td id="view-category"></td>
                            </tr>
                            <tr>
                                <th align="right">Bio</th>
                                <td id="view-bio"></td>
                            </tr>
                        </table>



                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- END view user modal window -->

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Users List</h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <div id="customButtons" style="margin-bottom:10px">
                            <button name="btnAdd" id="btnAdd" onclick="addRow()">Add New</button>
                        </div>
                        <table id="companiesTable" class="table table-bordered table-striped hover">
                            <thead>
                            <tr>
                                <th>Email</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Nickname</th>
                                <th>Streaming Key</th>
                                <th>Pic</th>
                                <th>Categories</th>
                                <th>Bio</th>
                            </tr>
                            </thead>
                            <tbody id="tbody-companies" onmouseover="this.style.cursor = 'pointer'" onmouseout="this.style.cursor = 'auto'">
                            <tr>
                                <td colspan="15">Loading...</td>
                            </tr>
                            </tbody>
                            <tfoot>
                            <tr>
                                <th>Email</th>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Nickname</th>
                                <th>Streaming Key</th>
                                <th>Pic</th>
                                <th>Categories</th>
                                <th>Bio</th>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                    <!-- /.card-body -->
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <!-- DataTables -->
    <script src="/assets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="/assets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="/assets/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="/assets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="/assets/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>


    <script>
        $(function () {



            function getUsers(){
                $.get("/api/users", function(data, status){
                    //alert("Data: " + data + "\nStatus: " + status);
                    if(status == 'success'){
                        gotUsers(data);
                    }else{
                        alert("Ajax error occurred");
                        console.log(data);
                        console.log(data.length);
                    }
                });
            }

            function gotUsers(data) {
                console.log("Got " + data.length + " users");
                var table = $("#tbody-companies");
                table.empty();
                data = JSON.parse(data);
                console.log("Cleared tbody");

                if(data.length < 1){
                    console.log("No data returned");
                    table.innerHTML = '<tr><td colspan="15">There are 0 users in the database</td></tr>';
                    return false;
                }

                console.log(data);
                //Add the data rows.
                var cell = "";
                var row = "";
                for (var i = 0; i < data.length; i++) {
                    // writing out line to debug console
                    console.log(data[i]);
                    row = $("<tr id='"+data[i]["id"]+"'/>");

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["email"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["firstName"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["lastName"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["nickname"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["streamingKey"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["profileImage"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["category"]+"</a>");
                    row.append(cell);

                    cell = $("<td />");
                    cell.html("<a href='#'  onclick=\"viewRow('" + data[i]["id"] + "')\">" + data[i]["bio"]+"</a>");
                    row.append(cell);

                    table.append(row);
                }
                $("#companiesTable").DataTable({
                    "responsive": true,
                    "autoWidth": false,
                });
            };


            getUsers();




        });

        function addRow(){
            document.forms['userForm'].reset();
            document.getElementById('form-title').innerHTML = 'Add User';
            $('#modal-user-form').modal();
        }

        function viewRow(rowIdentifier){
            $.get("/api/user/"+rowIdentifier, function(data, status){
                //alert("Data: " + data + "\nStatus: " + status);
                if(status == 'success'){
                    console.log("Got user data");
                    data = JSON.parse(data);
                    showUser(data);
                }else{
                    alert("Ajax error occurred");
                    console.log(data);
                    console.log(data.length);
                }
            });
        }

        function showUser(data){
            // clearUserView();
            console.log(data);
            //TODO: add better error handling
            if(data.length != 1){alert("ERROR = numbr of users returned was not 1");}
            data = data[0];
            $("#view-id").html(data['id']);
            $("#view-email").html(data['email']);
            $("#view-password-hash").html(data['passwordHash']);
            $("#view-nickname").html(data['nickname']);
            $("#view-first-name").html(data['firstName']);
            $("#view-last-name").html(data['lastName']);
            $("#view-streaming-key").html(data['streamingKey']);
            $("#view-profile-image").html(data['profileImage']);
            $("#view-category").html(data['category']);
            $("#view-bio").html(data['bio']);
            document.getElementById('view-title').innerHTML = 'View User - ' + data['nickname'] + '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
            if(data['streamingKey'] != null){
                $('#btnAddStream').hide();
                $('#btnRemoveStream').show();
            }else{
                $('#btnAddStream').show();
                $('#btnRemoveStream').hide();
            }



            $('#modal-user-view').modal();
            //$("#no-contacts-found").show();
            //$("#contactsTable").hide();
            /*
            $("#contactsTable").DataTable({
                "responsive": true,
                "autoWidth": false,
            });
            */
            // get contacts via ajax
            // getContacts(data["id"]);
        }


        function editRow(rowIdentifier){
            $.get("/api/user/"+rowIdentifier, function(data, status){
                //alert("Data: " + data + "\nStatus: " + status);
                if(status == 'success'){
                    console.log("Got user data");
                    data = JSON.parse(data);
                    gotUser(data);
                }else{
                    alert("Ajax error occurred");
                    console.log(data);
                    console.log(data.length);
                }
            });
        }

        function gotUser(data){
            //wdit user modal

            data = data[0];
            console.log(data);
            document.forms['userForm'].reset();
            $("#form-id").val(data['id']);
            $("#form-first-name").val(data['firstName']);
            $("#form-last-name").val(data['lasName']);
            $("#form-email").val(data['email']);
            $("#form-nickname").val(data['nickname']);

            document.getElementById('form-title').innerHTML = 'Edit User';
            $('#modal-company-form').modal();
        }

    </script>
{% endblock %}